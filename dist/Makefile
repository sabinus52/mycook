#---
#--- Commandes de l'application
#--- â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
#--- 
##
## Options disponibles :
##

# Chargement des variables d'environnement
include .env

# Arguments de la commande make
ARGS = $(filter-out $@,$(MAKECMDGOALS))

# Code de l'application
ifndef APP_CODE
$(error !!! APP_CODE is not set in .env !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!)
	APP_CODE = app
endif

# Nom de l'application = Code de l'application avec la premiÃ¨re lettre en majuscule
APP_NAME = $(shell echo $(APP_CODE) | sed -E 's/^(.)(.*)/\U\1\L\2/')

# Binaire (local)
DOCKER = docker
COMPOSE = docker compose
WEBAPP_DOCKER = $(COMPOSE) exec webapp
# Binaire dans le container FrankenPHP
PHP = $(WEBAPP_DOCKER) php
COMPOSER = $(WEBAPP_DOCKER) composer
SYMFONY = $(WEBAPP_DOCKER) bin/console


.DEFAULT_GOAL = help
.PHONY: logs up down compose bash
.PHONY: composer install vendor update sf dotenv cc schema migrate
.PHONY: data-dump data-restore


help: Makefile ## Affiche cette aide
	@sed -n 's/^#---//p' $<
	@grep -E '(^[a-zA-Z0-9_-]+:.*?##.*$$)|(^##)' Makefile | awk 'BEGIN {FS = ":.*?## "}{printf "  \033[32m%-20s\033[0m %s\n", $$1, $$2}' | sed -e 's/\[32m##/[33m\x08\x08\x08/'



## â€”â€”â€” ðŸ³ Containers Docker â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

up: ## DÃ©marrage du service Docker FrankenPHP, MariaDB et autres services
	@$(COMPOSE) up --detach --remove-orphans --wait

down: ## ArrÃªt du service Docker FrankenPHP, MariaDB et autres services
	@$(COMPOSE) down --remove-orphans

compose: ## ExÃ©cute docker-compose avec ses arguments
	@$(COMPOSE) $(ARGS)

logs: ## Log des containers Docker avec le nom du container possible
	@$(COMPOSE) logs --tail=100 --follow --timestamps $(ARGS)

bash: ## ExÃ©cute un bash dans le container FrankenPHP
	@$(WEBAPP_DOCKER) bash



## â€”â€”â€” ðŸ—ï¸  Projet â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

composer: ## ExÃ©cute une commande Composer
	@$(COMPOSER) $(ARGS)

check: ## VÃ©rification du projet ðŸ©º
	@echo
	@echo "\e[1;33mVÃ©rification du projet ðŸ”\e[0;0m"
	@echo "\e[1;33m=========================\e[0;0m"
	@echo
	@echo "  Nom du projet : \e[1;34m$(APP_NAME)\e[0;0m"
	@echo "  Version Symfony : \e[1;34m$(shell $(SYMFONY) --version | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')\e[0;0m"
	@echo "  Version PHP : \e[1;34m$(shell $(PHP) -r "echo PHP_MAJOR_VERSION.'.'.PHP_MINOR_VERSION;")\e[0;0m"
	@echo
	@$(SYMFONY) debug:dotenv

sf: ## ExÃ©cute une commande Symfony
	@$(SYMFONY) $(ARGS)

cc: ## Nettoyage des fichiers de cache
	@$(SYMFONY) cache:clear

schema: ## VÃ©rification de la validitÃ© de la structure de la base de donnÃ©es ðŸ©º
	@$(SYMFONY) doctrine:schema:validate -v

migrate: ## Mise Ã  jour de la structure de la base de donnÃ©es
	@$(SYMFONY) doctrine:migrations:migrate



## â€”â€”â€” ðŸ—ƒï¸  Base de donnÃ©es MariaDB â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

data-dump: ## Exporter les donnÃ©es de la base de donnÃ©es "make data-dump file=/tmp/dump.sql"
	@$(eval file ?= /tmp/dump.sql)
	@$(COMPOSE) exec database bash -c 'mariadb-dump --user=$$MARIADB_USER --password=$$MARIADB_PASSWORD $$MARIADB_DATABASE' > $(file)
	@echo "[OK] Fichier de dump de la base de donnÃ©es exportÃ© dans : $(file)"


data-restore: ## Restaurer les donnÃ©es de la base de donnÃ©es "make data-restore file=/tmp/dump.sql"
ifeq ($(strip $(file)),)
	$(error Le dump n'a pas Ã©tÃ© renseignÃ© : "make data-restore file=/tmp/dump.sql")
endif
	@$(COMPOSE) exec -T database bash -c 'mariadb --user=$$MARIADB_USER --password=$$MARIADB_PASSWORD $$MARIADB_DATABASE' < $(file)
	@echo "[OK] Fichier de dump '$(file)' de la base de donnÃ©es importÃ© dans la base de donnÃ©es"
